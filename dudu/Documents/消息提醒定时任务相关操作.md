# 消息提醒定时任务相关操作

### 简介
代码位置是 `app\Console\Kernel.php`，其下的 `schedule()` 方法内的代码会在每次进行定时任务时执行。

需要的额外工作：将

```
* * * * * cd /path-to-your-project && php artisan schedule:run >> /dev/null 2>&1
```

添加进系统的 crontab 定时任务，编辑进入的方式为 `crontab -e`，进去之后用 Vim 的操作把上面一行代码添加到末尾保存退出即可。

添加完成后，系统会每分钟执行一次（前面五个星号定义的间隔时间是一分钟），这个时间间隔的选择是因为日程提醒时间是精确到分钟的，为了保证能以分钟的精度提醒用户，这里的设置也得是同样的级别。

### 测试
直接模拟跑一遍定时任务内的操作代码：

```
php artisan schedule:run
```

注意未完成任务检查的操作是在每天 17:00 进行的（`dailyAt('17:00')`），需要修改时间的话可以自行在代码里面修改，为了能方便测试可以暂时将这个改成每分钟检查的 `everyMinute()`，代码就在这一行的下面直接取消注释就行了。

运行完之后应该能看到新增的任务提醒和日程提醒的消息记录，没问题的话就可以恢复修改进行实际的使用了。

### 拓展和注意事项
目前已经写好的有任务模块（`task_user` 表中状态为未签收或未上报且日期为当前日期的）和日程模块（`schedule` 表中 `remind_at` 值为当前时间的）两个，后续如果需要拓展的话直接参照这两个写法在后面追加即可。

注意上线跑的环境，因为不仅仅这一个地方用到了时间相关的东西，所以务必保证数据库、PHP 语言和系统时间都尽量同步，建议是统一使用 `UTC +8` 即 `Asia/Shanghai` 的时区。

数据库的时间查看使用 `SELECT NOW()` 即可，时区查看用 `SELECT @@timezone`，一般默认是 `SYSTEM`，也就是跟随系统时区，这也是为什么要求系统时区也要同步着用 `UTC +8`，不建议修改这个值，让它保持跟随系统的状态就好，手动设置数据库的时区可能会碰到一些麻烦的问题
